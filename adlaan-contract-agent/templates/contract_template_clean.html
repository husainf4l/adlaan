<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Adlaan Contract Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-blue: #4f46e5;
        --primary-purple: #7c3aed;
        --success-green: #10b981;
        --warning-orange: #f59e0b;
        --error-red: #ef4444;

        --surface-white: rgba(255, 255, 255, 0.95);
        --surface-glass: rgba(255, 255, 255, 0.1);
        --surface-dark: rgba(15, 23, 42, 0.9);

        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-light: #94a3b8;

        --border-light: rgba(226, 232, 240, 0.5);
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.12);
        --shadow-strong: 0 16px 48px rgba(0, 0, 0, 0.16);

        --radius-sm: 12px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --radius-full: 50px;

        --spacing-xs: 8px;
        --spacing-sm: 16px;
        --spacing-md: 24px;
        --spacing-lg: 32px;
        --spacing-xl: 48px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 25%,
          #334155 50%,
          #4f46e5 75%,
          #7c3aed 100%
        );
        min-height: 100vh;
        color: var(--text-primary);
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100vh;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        max-width: 1600px;
        margin: 0 auto;
      }

      /* Chat Panel */
      .chat-panel {
        flex: 0 0 450px;
        display: flex;
        flex-direction: column;
        background: var(--surface-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-strong);
        backdrop-filter: blur(40px);
        overflow: hidden;
      }

      .chat-header {
        padding: var(--spacing-md);
        background: linear-gradient(
          135deg,
          var(--surface-white),
          rgba(248, 250, 252, 0.9)
        );
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .chat-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--success-green);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(16, 185, 129, 0.1);
        }
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .message {
        max-width: 85%;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 15px;
        line-height: 1.5;
        animation: slideIn 0.3s ease-out;
      }

      .message.user {
        align-self: flex-end;
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--primary-purple)
        );
        color: white;
        border-bottom-right-radius: var(--radius-sm);
      }

      .message.assistant {
        align-self: flex-start;
        background: rgba(248, 250, 252, 0.8);
        color: var(--text-primary);
        border: 1px solid var(--border-light);
        border-bottom-left-radius: var(--radius-sm);
      }

      .message.system {
        align-self: center;
        background: rgba(239, 246, 255, 0.8);
        color: var(--primary-blue);
        border: 1px solid rgba(79, 70, 229, 0.2);
        font-size: 14px;
        text-align: center;
        max-width: 70%;
      }

      .message.thinking {
        align-self: flex-start;
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #f59e0b;
        font-size: 14px;
        font-style: italic;
      }

      .typing-indicator {
        align-self: flex-start;
        display: flex;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-md);
        background: rgba(248, 250, 252, 0.8);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        border-bottom-left-radius: var(--radius-sm);
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-light);
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        40% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .chat-input-container {
        padding: var(--spacing-md);
        background: var(--surface-white);
        border-top: 1px solid var(--border-light);
      }

      .chat-input-wrapper {
        position: relative;
        display: flex;
        gap: var(--spacing-sm);
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        min-height: 52px;
        max-height: 120px;
        padding: var(--spacing-sm) 60px var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-lg);
        font-size: 15px;
        font-family: inherit;
        resize: none;
        outline: none;
        background: white;
        transition: all 0.3s ease;
      }

      .chat-input:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      }

      .send-button {
        position: absolute;
        right: var(--spacing-xs);
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--primary-purple)
        );
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .send-button:hover:not(:disabled) {
        transform: translateY(-50%) scale(1.05);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Document Panel */
      .document-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--surface-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-strong);
        backdrop-filter: blur(40px);
        overflow: hidden;
      }

      .document-header {
        padding: var(--spacing-md);
        background: linear-gradient(
          135deg,
          var(--surface-white),
          rgba(248, 250, 252, 0.9)
        );
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .document-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .document-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .action-button {
        padding: var(--spacing-xs) var(--spacing-sm);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-sm);
        background: white;
        color: var(--text-secondary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .action-button:hover {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
      }

      .document-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-light);
        text-align: center;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .contract-section {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        background: white;
        border-radius: var(--radius-md);
        border-left: 4px solid var(--primary-blue);
        box-shadow: var(--shadow-soft);
        animation: slideUp 0.5s ease-out;
      }

      .section-header {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .section-content {
        color: var(--text-primary);
        line-height: 1.6;
        font-size: 15px;
      }

      .section-content.arabic {
        direction: rtl;
        text-align: right;
        font-family: "Inter", "Arial Unicode MS", Tahoma, sans-serif;
      }

      .placeholder {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 14px;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
          gap: var(--spacing-sm);
          padding: var(--spacing-sm);
        }

        .chat-panel {
          flex: 0 0 300px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Chat Panel -->
      <div class="chat-panel">
        <div class="chat-header">
          <div class="chat-title">Contract Assistant</div>
          <div class="status-indicator"></div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message system">
            Welcome! I can help you generate contract templates. What type of
            contract would you like to create?
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea
              id="chatInput"
              class="chat-input"
              placeholder="Ask me to create a contract..."
              rows="1"
            ></textarea>
            <button id="sendButton" class="send-button" disabled>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path
                  d="M22 2L11 13"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M22 2L15 22L11 13L2 9L22 2Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Document Panel -->
      <div class="document-panel">
        <div class="document-header">
          <div class="document-title">Contract Document</div>
          <div class="document-actions">
            <button class="action-button" onclick="downloadContract()">
              üìÑ Download
            </button>
            <button class="action-button" onclick="printContract()">
              üñ®Ô∏è Print
            </button>
            <button class="action-button" onclick="clearDocument()">
              üóëÔ∏è Clear
            </button>
          </div>
        </div>

        <div class="document-content" id="documentContent">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div>No contract generated yet</div>
            <div style="font-size: 14px; margin-top: 8px; opacity: 0.7">
              Start a conversation to generate your contract
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class AdlaanContractAgent {
        constructor() {
          this.elements = {
            chatMessages: document.getElementById("chatMessages"),
            chatInput: document.getElementById("chatInput"),
            sendButton: document.getElementById("sendButton"),
            documentContent: document.getElementById("documentContent"),
          };

          this.sections = new Map();
          this.currentMessage = null;
          this.typingIndicator = null;

          this.init();
        }

        init() {
          this.setupEventListeners();
          this.setupInputAutoResize();
        }

        setupEventListeners() {
          this.elements.sendButton.addEventListener("click", () =>
            this.sendMessage()
          );
          this.elements.chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              this.sendMessage();
            }
          });
          this.elements.chatInput.addEventListener("input", () =>
            this.updateSendButton()
          );
        }

        setupInputAutoResize() {
          this.elements.chatInput.addEventListener("input", (e) => {
            e.target.style.height = "auto";
            e.target.style.height = Math.min(e.target.scrollHeight, 120) + "px";
          });
        }

        updateSendButton() {
          const hasText = this.elements.chatInput.value.trim().length > 0;
          this.elements.sendButton.disabled = !hasText;
        }

        async sendMessage() {
          const message = this.elements.chatInput.value.trim();
          if (!message) return;

          this.addMessage(message, "user");
          this.clearInput();
          this.showTypingIndicator();

          try {
            await this.streamResponse(message);
          } catch (error) {
            console.error("Error sending message:", error);
            this.addMessage(
              "Sorry, there was an error processing your request.",
              "assistant"
            );
          } finally {
            this.hideTypingIndicator();
          }
        }

        async streamResponse(message) {
          const response = await fetch("/chat/stream", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              contract_type: this.detectContractType(message),
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          try {
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value);
              const lines = chunk.split("\n");

              for (const line of lines) {
                if (line.startsWith("data: ")) {
                  try {
                    const data = JSON.parse(line.slice(6));
                    await this.processStreamData(data);
                  } catch (error) {
                    console.warn("Error parsing stream data:", error);
                  }
                }
              }
            }
          } finally {
            reader.releaseLock();
          }
        }

        async processStreamData(data) {
          if (!data.data || !Array.isArray(data.data)) return;

          for (const chunk of data.data) {
            if (chunk.error || chunk.code !== 0) {
              console.error("Stream error:", chunk);
              continue;
            }

            const eventData = this.parseAgentEvent(chunk.agentEvent);
            if (!eventData) continue;

            await this.handleStreamEvent(eventData, chunk);
          }
        }

        parseAgentEvent(agentEvent) {
          try {
            return JSON.parse(agentEvent);
          } catch (error) {
            console.warn("Error parsing agent event:", error);
            return null;
          }
        }

        async handleStreamEvent(eventData, chunk) {
          const { event, nodeId, message } = eventData;
          const { param, content_type } = message || {};

          switch (event) {
            case "MESSAGE_COT":
              if (nodeId === "COT") {
                this.addMessage(`üí≠ ${param}`, "thinking");
              } else if (nodeId === "CHAT") {
                if (message.action === "‚öôÔ∏è Processing") {
                  this.currentMessage = this.addOrUpdateStreamingMessage(
                    param,
                    content_type
                  );

                  // Add to document if substantial and can be added to note
                  if (chunk.canAddToNote && param && param.length > 20) {
                    this.addToDocument(param, content_type);
                  }
                }
              }
              break;

            case "CONTRACT_GENERATION":
              this.addMessage(`üìù ${param}`, "system");
              break;

            case "ERROR":
              this.addMessage(`‚ùå ${param}`, "assistant");
              break;
          }
        }

        detectContractType(message) {
          const text = message.toLowerCase();
          if (
            text.includes("employment") ||
            text.includes("work") ||
            text.includes("job")
          ) {
            return "employment";
          }
          if (text.includes("service") || text.includes("freelance")) {
            return "service";
          }
          if (text.includes("rental") || text.includes("lease")) {
            return "rental";
          }
          return "general";
        }

        addMessage(content, type) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${type}`;
          messageDiv.textContent = content;

          this.elements.chatMessages.appendChild(messageDiv);
          this.scrollToBottom();

          return messageDiv;
        }

        addOrUpdateStreamingMessage(content, contentType) {
          if (this.currentMessage && contentType === "text") {
            // Append to existing message
            this.currentMessage.textContent += content;
          } else {
            // Create new message
            this.currentMessage = this.addMessage(content, "assistant");
          }

          this.scrollToBottom();
          return this.currentMessage;
        }

        addToDocument(content, contentType) {
          this.hideEmptyState();

          const sectionTitle = this.getSectionTitle(contentType);
          const sectionId = `section-${contentType}`;

          let section = this.sections.get(sectionId);
          if (!section) {
            section = this.createDocumentSection(sectionTitle, sectionId);
            this.sections.set(sectionId, section);
            this.elements.documentContent.appendChild(section);
          }

          const sectionContent = section.querySelector(".section-content");
          const cleanContent = this.cleanContent(content, contentType);

          if (contentType === "contract_header") {
            sectionContent.innerHTML = cleanContent;
          } else {
            sectionContent.innerHTML += cleanContent;
          }

          // Add Arabic class if content contains Arabic text
          if (this.isArabicText(cleanContent)) {
            sectionContent.classList.add("arabic");
          }
        }

        createDocumentSection(title, id) {
          const section = document.createElement("div");
          section.className = "contract-section";
          section.id = id;

          const header = document.createElement("div");
          header.className = "section-header";
          header.textContent = title;

          const content = document.createElement("div");
          content.className = "section-content";

          section.appendChild(header);
          section.appendChild(content);

          return section;
        }

        getSectionTitle(contentType) {
          const titles = {
            contract_header: "ÿπŸÇÿØ ÿßŸÑÿπŸÖŸÑ",
            contract_body: "ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿπŸÇÿØ",
            contract_signature: "ÿßŸÑÿ™ŸàŸÇŸäÿπÿßÿ™",
            text: "ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ©",
          };
          return titles[contentType] || "ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿπŸÇÿØ";
        }

        cleanContent(content, contentType) {
          // Remove markdown and formatting codes
          return content
            .replace(/\[CB\]|\[CH\]|\[CF\]/g, "")
            .replace(/```arabic|```/g, "")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\[(.*?)\]/g, '<span class="placeholder">$1</span>')
            .replace(/\n/g, "<br>")
            .trim();
        }

        isArabicText(text) {
          const arabicPattern = /[\u0600-\u06FF\u0750-\u077F]/;
          return arabicPattern.test(text);
        }

        showTypingIndicator() {
          this.typingIndicator = document.createElement("div");
          this.typingIndicator.className = "typing-indicator";
          this.typingIndicator.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
          this.elements.chatMessages.appendChild(this.typingIndicator);
          this.scrollToBottom();
        }

        hideTypingIndicator() {
          if (this.typingIndicator) {
            this.typingIndicator.remove();
            this.typingIndicator = null;
          }
        }

        hideEmptyState() {
          const emptyState =
            this.elements.documentContent.querySelector(".empty-state");
          if (emptyState) {
            emptyState.style.display = "none";
          }
        }

        clearInput() {
          this.elements.chatInput.value = "";
          this.elements.chatInput.style.height = "auto";
          this.updateSendButton();
        }

        scrollToBottom() {
          requestAnimationFrame(() => {
            this.elements.chatMessages.scrollTop =
              this.elements.chatMessages.scrollHeight;
          });
        }
      }

      // Global functions for document actions
      function downloadContract() {
        const content = document.getElementById("documentContent");
        const contractHTML = content.innerHTML;

        const blob = new Blob(
          [
            `
                <!DOCTYPE html>
                <html><head>
                <meta charset="UTF-8">
                <style>
                body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .contract-section { margin-bottom: 30px; }
                .section-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; }
                .section-content.arabic { direction: rtl; text-align: right; }
                .placeholder { background: #FEF3C7; color: #92400E; padding: 2px 6px; border-radius: 4px; }
                </style>
                </head><body>
                ${contractHTML}
                </body></html>
            `,
          ],
          { type: "text/html" }
        );

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "contract.html";
        a.click();
        URL.revokeObjectURL(url);
      }

      function printContract() {
        const content = document.getElementById("documentContent");
        const printWindow = window.open("", "_blank");
        printWindow.document.write(`
                <!DOCTYPE html>
                <html><head>
                <meta charset="UTF-8">
                <style>
                body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .contract-section { margin-bottom: 30px; page-break-inside: avoid; }
                .section-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; }
                .section-content.arabic { direction: rtl; text-align: right; }
                .placeholder { background: #FEF3C7; color: #92400E; padding: 2px 6px; border-radius: 4px; }
                </style>
                </head><body>
                ${content.innerHTML}
                </body></html>
            `);
        printWindow.document.close();
        printWindow.print();
      }

      function clearDocument() {
        if (confirm("Are you sure you want to clear the document?")) {
          const documentContent = document.getElementById("documentContent");
          documentContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div>No contract generated yet</div>
                        <div style="font-size: 14px; margin-top: 8px; opacity: 0.7;">
                            Start a conversation to generate your contract
                        </div>
                    </div>
                `;
        }
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", () => {
        window.contractAgent = new AdlaanContractAgent();
      });
    </script>
  </body>
</html>
