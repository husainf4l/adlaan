{% extends 'base.html' %}
{% load static %}

{% block title %}AI Chat & Document Creator - Adlaan{% endblock %}

{% block content %}
<main class="h-screen flex flex-col bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-full px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-semibold text-gray-900">AI Document Assistant</h1>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                        Online
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <button class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Export
                    </button>
                    <button class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-black hover:bg-gray-800">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Save Document
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content - Split View -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Half: Chat Interface -->
        <div class="w-1/2 flex flex-col border-r border-gray-200">
            <!-- Chat Header -->
            <div class="bg-white px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900 flex items-center">
                    <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3">
                        <span class="text-white font-bold text-sm">A</span>
                    </div>
                    Adlaan AI Assistant
                </h2>
                <p class="text-sm text-gray-500 mt-1">Ask me to create legal documents, contracts, and agreements</p>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto bg-gray-50 p-6" id="chat-messages">
                <!-- Welcome Message -->
                <div class="flex mb-6">
                    <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <span class="text-white font-bold text-xs">A</span>
                    </div>
                    <div class="bg-white rounded-lg px-4 py-3 max-w-md shadow-sm">
                        <p class="text-sm text-gray-800">
                            Hello! I'm Adlaan, your AI legal assistant. I can help you create various legal documents. What would you like to work on today?
                        </p>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button class="action-btn bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-md hover:bg-blue-200" data-action="create_agreement">
                                üìÑ Create Agreement
                            </button>
                            <button class="action-btn bg-green-100 text-green-800 text-xs px-2 py-1 rounded-md hover:bg-green-200" data-action="create_contract">
                                üìã Create Contract
                            </button>
                            <button class="action-btn bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-md hover:bg-purple-200" data-action="create_nda">
                                üîí Create NDA
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sample User Message -->
                <div class="flex justify-end mb-6">
                    <div class="bg-gray-600 text-white rounded-lg px-4 py-3 max-w-md">
                        <p class="text-sm">I need to create a service agreement for my consulting business</p>
                    </div>
                </div>

                <!-- Sample AI Response -->
                <div class="flex mb-6">
                    <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <span class="text-white font-bold text-xs">A</span>
                    </div>
                    <div class="bg-white rounded-lg px-4 py-3 max-w-md shadow-sm">
                        <p class="text-sm text-gray-800">
                            I'll help you create a comprehensive service agreement. Let me start by gathering some key information:
                        </p>
                        <ul class="mt-2 text-sm text-gray-600 space-y-1">
                            <li>‚Ä¢ What type of consulting services do you provide?</li>
                            <li>‚Ä¢ What are your typical project timelines?</li>
                            <li>‚Ä¢ Do you have specific payment terms?</li>
                        </ul>
                        <div class="mt-3">
                            <button class="action-btn bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-md hover:bg-blue-200" data-action="start_service_agreement">
                                üöÄ Start Creating Document
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="bg-white border-t border-gray-200 px-6 py-4">
                <div class="flex items-center space-x-3">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="chat-input"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent resize-none pr-12" 
                            placeholder="Type your message to Adlaan..."
                            maxlength="500"
                        />
                        <button 
                            id="send-button"
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600 transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                    <span>Press Enter to send, Shift+Enter for new line</span>
                    <span id="char-count">0/500</span>
                </div>
            </div>
        </div>

        <!-- Right Half: Document Editor -->
        <div class="w-1/2 flex flex-col">
            <!-- Document Header -->
            <div class="bg-white px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium text-gray-900">Document Preview</h2>
                        <p class="text-sm text-gray-500">Real-time document generation</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                            <option value="agreement">Service Agreement</option>
                            <option value="contract">Contract</option>
                            <option value="nda">Non-Disclosure Agreement</option>
                            <option value="terms">Terms of Service</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Document Editor Area -->
            <div class="flex-1 bg-white">
                <!-- Document Toolbar -->
                <div class="border-b border-gray-200 px-6 py-3 bg-gray-50">
                    <div class="flex items-center space-x-4">
                        <button class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded" title="Bold">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"/>
                            </svg>
                        </button>
                        <button class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded" title="Italic">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4l4 16"/>
                            </svg>
                        </button>
                        <div class="w-px h-6 bg-gray-300"></div>
                        <button class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded" title="Bullet List">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <button class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded" title="Numbered List">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                            </svg>
                        </button>
                        <div class="w-px h-6 bg-gray-300"></div>
                        <button class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded" title="AI Suggestions">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Document Content Area -->
                <div class="p-8 h-full overflow-y-auto" style="background: linear-gradient(to right, #f8f9fa 0%, #f8f9fa 60px, transparent 60px), repeating-linear-gradient(transparent, transparent 24px, #e5e7eb 24px, #e5e7eb 25px);">
                    <!-- Document Paper Style -->
                    <div class="bg-white shadow-lg mx-auto max-w-3xl min-h-full" style="box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                        <!-- Document Header -->
                        <div class="p-8 border-b-2 border-gray-200">
                            <div class="text-center">
                                <h1 class="text-2xl font-bold text-gray-900 mb-2" id="document-title">SERVICE AGREEMENT</h1>
                                <p class="text-sm text-gray-600">Generated by Adlaan AI Legal Assistant</p>
                            </div>
                        </div>

                        <!-- Document Body -->
                        <div class="p-8 space-y-6" id="document-content">
                            <!-- Placeholder content -->
                            <div class="text-gray-500 italic text-center py-16">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-lg mb-2">Document will appear here</p>
                                <p class="text-sm">Start chatting with Adlaan to generate your legal document</p>
                            </div>

                            <!-- Sample content that would be generated -->
                            <div class="hidden" id="sample-agreement">
                                <div class="space-y-4">
                                    <p class="text-sm text-gray-900 leading-relaxed">
                                        This Service Agreement ("Agreement") is entered into on [DATE] between [CLIENT NAME], a [CLIENT ENTITY TYPE] ("Client") and [SERVICE PROVIDER NAME], a [PROVIDER ENTITY TYPE] ("Service Provider").
                                    </p>

                                    <h3 class="text-lg font-semibold text-gray-900 mt-6">1. SERVICES</h3>
                                    <p class="text-sm text-gray-900 leading-relaxed">
                                        Service Provider agrees to provide the following consulting services:
                                    </p>
                                    <ul class="list-disc list-inside text-sm text-gray-900 ml-4 space-y-1">
                                        <li>[SERVICE DESCRIPTION 1]</li>
                                        <li>[SERVICE DESCRIPTION 2]</li>
                                        <li>[SERVICE DESCRIPTION 3]</li>
                                    </ul>

                                    <h3 class="text-lg font-semibold text-gray-900 mt-6">2. COMPENSATION</h3>
                                    <p class="text-sm text-gray-900 leading-relaxed">
                                        Client agrees to pay Service Provider [PAYMENT AMOUNT] for the services described herein. Payment terms: [PAYMENT TERMS].
                                    </p>

                                    <h3 class="text-lg font-semibold text-gray-900 mt-6">3. TERM</h3>
                                    <p class="text-sm text-gray-900 leading-relaxed">
                                        This Agreement shall commence on [START DATE] and continue until [END DATE], unless terminated earlier in accordance with the provisions herein.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Document Footer -->
                        <div class="p-8 border-t-2 border-gray-200 bg-gray-50">
                            <div class="grid grid-cols-2 gap-8">
                                <div>
                                    <div class="border-t border-gray-400 pt-2">
                                        <p class="text-sm text-gray-600">Client Signature</p>
                                        <p class="text-xs text-gray-500">Date: ________________</p>
                                    </div>
                                </div>
                                <div>
                                    <div class="border-t border-gray-400 pt-2">
                                        <p class="text-sm text-gray-600">Service Provider Signature</p>
                                        <p class="text-xs text-gray-500">Date: ________________</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const charCount = document.getElementById('char-count');
    const documentContent = document.getElementById('document-content');
    const documentTitle = document.getElementById('document-title');

    let currentThreadId = null;
    let isStreaming = false;

    // Character counter
    chatInput.addEventListener('input', function() {
        charCount.textContent = `${this.value.length}/500`;
    });

    // Send message function
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (message && !isStreaming) {
            isStreaming = true;

            // Add user message to chat
            const userMessage = document.createElement('div');
            userMessage.className = 'flex justify-end mb-6';
            userMessage.innerHTML = `
                <div class="bg-gray-600 text-white rounded-lg px-4 py-3 max-w-md">
                    <p class="text-sm">${message}</p>
                </div>
            `;
            chatMessages.appendChild(userMessage);

            // Clear input
            chatInput.value = '';
            charCount.textContent = '0/500';

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Add AI thinking message
            const aiMessage = document.createElement('div');
            aiMessage.className = 'flex mb-6';
            aiMessage.id = 'current-ai-message';
            aiMessage.innerHTML = `
                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                    <span class="text-white font-bold text-xs">A</span>
                </div>
                <div class="bg-white rounded-lg px-4 py-3 max-w-md shadow-sm">
                    <p class="text-sm text-gray-800">Thinking and planning your document...</p>
                    <div class="mt-2">
                        <div class="animate-pulse flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(aiMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Call the chat API
                const response = await fetch('http://localhost:8005/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        thread_id: currentThreadId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedResponse = '';
                let currentStage = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                if (data.type === 'start') {
                                    currentThreadId = data.thread_id;
                                } else if (data.type === 'token') {
                                    accumulatedResponse += data.content;
                                    updateAIMessage(`Generating document content...`, accumulatedResponse);
                                } else if (data.type === 'end') {
                                    updateAIMessage(`Document generation complete!`, accumulatedResponse);
                                    updateDocumentContent(accumulatedResponse, message);
                                } else if (data.type === 'error') {
                                    updateAIMessage(`‚ùå Error: ${data.content}`, accumulatedResponse);
                                }
                            } catch (e) {
                                console.log('Parse error:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                updateAIMessage(`‚ùå Connection error: ${error.message}`);
            } finally {
                isStreaming = false;
            }
        }
    }

    function updateAIMessage(status, content = null) {
        const aiMessage = document.getElementById('current-ai-message');
        if (aiMessage) {
            const contentDiv = aiMessage.querySelector('.bg-white');
            if (content) {
                contentDiv.innerHTML = `
                    <p class="text-sm text-gray-800">${status}</p>
                    <div class="mt-2 p-3 bg-gray-50 rounded text-xs font-mono max-h-32 overflow-y-auto">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <p class="text-sm text-gray-800">${status}</p>
                    <div class="mt-2">
                        <div class="animate-pulse flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        </div>
                    </div>
                `;
            }
        }
    }

    function updateDocumentContent(content, originalMessage) {
        // Hide placeholder
        const placeholder = documentContent.querySelector('.text-gray-500');
        if (placeholder) {
            placeholder.style.display = 'none';
        }

        // Show document content
        const sampleAgreement = document.getElementById('sample-agreement');
        if (sampleAgreement) {
            sampleAgreement.classList.remove('hidden');
            sampleAgreement.innerHTML = formatDocumentContent(content, originalMessage);
        }

        // Update document title based on content
        if (originalMessage.toLowerCase().includes('nda') || originalMessage.toLowerCase().includes('non-disclosure')) {
            documentTitle.textContent = 'NON-DISCLOSURE AGREEMENT';
        } else if (originalMessage.toLowerCase().includes('contract')) {
            documentTitle.textContent = 'CONTRACT AGREEMENT';
        } else if (originalMessage.toLowerCase().includes('service')) {
            documentTitle.textContent = 'SERVICE AGREEMENT';
        }
    }

    function formatDocumentContent(content, originalMessage) {
        // Basic formatting - in a real app, this would be more sophisticated
        let formatted = content;

        // Add some basic structure
        if (!formatted.includes('<h3>') && !formatted.includes('###')) {
            // Try to identify sections
            formatted = formatted.replace(/\b(\d+)\.\s*([A-Z\s]+):/g, '<h3 class="text-lg font-semibold text-gray-900 mt-6">$1. $2</h3>');
            formatted = formatted.replace(/\b([A-Z][A-Z\s]+):/g, '<h3 class="text-lg font-semibold text-gray-900 mt-6">$1</h3>');
        }

        // Convert markdown-style headers if present
        formatted = formatted.replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold text-gray-900 mt-6">$1</h3>');
        formatted = formatted.replace(/^## (.*$)/gm, '<h2 class="text-xl font-semibold text-gray-900 mt-8">$1</h2>');
        formatted = formatted.replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold text-gray-900 mt-8">$1</h1>');

        // Convert line breaks
        formatted = formatted.replace(/\n\n/g, '</p><p class="text-sm text-gray-900 leading-relaxed mt-4">');
        formatted = formatted.replace(/\n/g, '<br>');

        // Wrap in paragraph tags
        if (!formatted.includes('<p>')) {
            formatted = `<p class="text-sm text-gray-900 leading-relaxed">${formatted}</p>`;
        }

        return `<div class="space-y-4">${formatted}</div>`;
    }

    // Send on Enter key
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Send button click
    sendButton.addEventListener('click', sendMessage);

    // Action buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('action-btn')) {
            const action = e.target.dataset.action;

            if (action === 'create_agreement') {
                chatInput.value = 'Create a service agreement for my consulting business';
                sendMessage();
            } else if (action === 'create_contract') {
                chatInput.value = 'Create a contract agreement for software development services';
                sendMessage();
            } else if (action === 'create_nda') {
                chatInput.value = 'Create a non-disclosure agreement for business partnership';
                sendMessage();
            } else if (action === 'start_service_agreement') {
                chatInput.value = 'Please create a comprehensive service agreement with standard clauses';
                sendMessage();
            }
        }
    });
});
</script>
{% endblock %}